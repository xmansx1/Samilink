{# marketplace/templates/marketplace/request_detail.html #}
{% extends "base.html" %}
{% block title %}Ø·Ù„Ø¨ #{{ req.pk }}{% endblock %}
{% block content %}
<section class="py-8 max-w-6xl mx-auto rtl" dir="rtl">

  <div class="rounded-2xl border bg-white/80 dark:bg-slate-800/70 backdrop-blur shadow-glass-lg overflow-hidden">

    {# ===== Toasts: Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù†Ø¸Ø§Ù… (Django messages) ===== #}
    {% if messages %}
    <div class="p-4 border-b bg-gradient-to-l from-emerald-50 to-sky-50 dark:from-slate-800 dark:to-slate-900">
      <div class="space-y-2" id="messages-area">
        {% for message in messages %}
          <div class="rounded-xl border px-4 py-3 text-sm flex items-start gap-2
                      {% if message.tags == 'success' %} bg-emerald-50 border-emerald-200 text-emerald-800 dark:bg-emerald-900/20 dark:border-emerald-900 dark:text-emerald-200
                      {% elif message.tags == 'warning' %} bg-amber-50 border-amber-200 text-amber-800 dark:bg-amber-900/20 dark:border-amber-900 dark:text-amber-200
                      {% elif message.tags == 'error' %} bg-rose-50 border-rose-200 text-rose-700 dark:bg-rose-900/20 dark:border-rose-200
                      {% else %} bg-slate-50 border-slate-200 text-slate-800 dark:bg-slate-900/30 dark:border-slate-800 dark:text-slate-200 {% endif %}">
            <div class="mt-0.5">â€¢</div>
            <div class="whitespace-pre-line">{{ message }}</div>
            <button type="button" class="ms-auto text-xs text-slate-500 hover:underline" data-close-alert>Ø¥ØºÙ„Ø§Ù‚</button>
          </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    {# ===== Header ===== #}
    <div class="p-6 border-b bg-gradient-to-l from-indigo-50 to-sky-50 dark:from-slate-800 dark:to-slate-900">
      <div class="flex items-start justify-between gap-6">
        <div class="min-w-0">
          <div class="flex items-center gap-2 flex-wrap">
            <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight text-slate-900 dark:text-white truncate">{{ req.title }}</h1>
            <span class="px-2 py-1 rounded-lg text-xs border bg-white dark:bg-slate-900 text-slate-700 dark:text-slate-300">#{{ req.pk }}</span>
            <span class="px-2 py-1 rounded-lg text-xs border bg-white dark:bg-slate-900 text-slate-700 dark:text-slate-300">
              {{ req.get_status_display|default:req.status }}
            </span>
            {% if req.agreement_overdue %}
              <span class="px-2 py-1 rounded-lg text-xs bg-red-50 text-red-700 border border-red-200">ØªØ¬Ø§ÙˆØ²Øª Ù…Ù‡Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ©</span>
            {% endif %}
          </div>
          <p class="text-slate-600 dark:text-slate-300 text-sm mt-2">
            Ø§Ù„Ø¹Ù…ÙŠÙ„: <b>{{ req.client }}</b>
            {% if req.assigned_employee %} â€” Ø§Ù„Ù…ÙˆØ¸Ù: <b>{{ req.assigned_employee }}</b>{% endif %}
          </p>
        </div>
        <div class="text-slate-500 dark:text-slate-400 text-sm shrink-0">
          Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: {{ req.updated_at|date:"Y-m-d H:i" }}
        </div>
      </div>

      {# ===== Ø´Ø±ÙŠØ· Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø¹Ø§Ù… (ÙØªØ­ Ù†Ø²Ø§Ø¹ + ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©) ===== #}
      {% if request.user.is_authenticated %}
        <div class="mt-4 flex flex-wrap items-center gap-2">

          {# Ø²Ø± ÙØªØ­ Ù†Ø²Ø§Ø¹: Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£Ùˆ Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…ÙØ³Ù†ÙØ¯ Ø£Ùˆ Ø§Ù„Ù…Ø¯ÙŠØ±/Ø³ØªØ§Ù #}
          {% if request.user.id == req.client_id or request.user.id == req.assigned_employee_id or request.user.is_staff or request.user.role == 'admin' %}
            <a href="{% url 'disputes:open' req.pk %}" class="btn btn-danger">ÙØªØ­ Ù†Ø²Ø§Ø¹</a>
          {% endif %}

          {# ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨: Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…ÙØ³Ù†ÙØ¯ Ø£Ùˆ Ø§Ù„Ù…Ø¯ÙŠØ±/Ø³ØªØ§Ù #}
          {% if request.user.is_staff or request.user.role == 'admin' %}
            <div class="rounded-xl border bg-white/70 dark:bg-slate-900/40 p-2 flex flex-wrap items-center gap-2">
              <span class="text-xs text-slate-600 dark:text-slate-300">ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©:</span>
              <form method="post" action="{% url 'marketplace:request_change_state' req.pk %}" class="inline"
                    onsubmit="return confirm('Ø³ÙŠØªÙ… ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ø·Ù„Ø¨ ÙƒÙ€ Â«Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©Â». Ù…ØªØ§Ø¨Ø¹Ø©ØŸ');">
                {% csrf_token %}
                <input type="hidden" name="state" value="awaiting_review">
                <button class="btn btn-secondary btn-xs">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</button>
              </form>
              <form method="post" action="{% url 'marketplace:request_change_state' req.pk %}" class="inline"
                    onsubmit="return confirm('Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ Â«Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°Â»ØŸ');">
                {% csrf_token %}
                <input type="hidden" name="state" value="in_progress">
                <button class="btn btn-secondary btn-xs">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</button>
              </form>
              {% if req.status == 'awaiting_payment' or req.state == 'awaiting_payment' %}
              <form method="post" action="{% url 'marketplace:request_change_state' req.pk %}" class="inline"
                    onsubmit="return confirm('ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ø·Ù„Ø¨ Â«Ù…ÙƒØªÙ…Ù„Â»ØŸ');">
                {% csrf_token %}
                <input type="hidden" name="state" value="completed">
                <button class="btn btn-success btn-xs">Ù…ÙƒØªÙ…Ù„</button>
              </form>
              {% endif %}
              <form method="post" action="{% url 'marketplace:request_cancel' req.pk %}" class="inline flex items-center gap-2"
                    onsubmit="return !!this.querySelector('[name=reason]').value || (alert('ÙØ¶Ù„Ø§Ù‹ Ø£Ø¯Ø®Ù„ Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ù„ØºØ§Ø¡.'), false)">
                {% csrf_token %}
                <input type="text" name="reason" class="input !py-1 !text-xs" placeholder="Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ù„ØºØ§Ø¡" required>
                <button class="btn btn-danger btn-xs">Ø¥Ù„ØºØ§Ø¡</button>
              </form>
            </div>
          {% elif request.user.id == req.assigned_employee_id %}
            <div class="rounded-xl border bg-white/70 dark:bg-slate-900/40 p-2 flex flex-wrap items-center gap-2">
              <span class="text-xs text-slate-600 dark:text-slate-300">ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©:</span>
              <form method="post" action="{% url 'marketplace:request_change_state' req.pk %}" class="inline"
                    onsubmit="return confirm('Ø³ÙŠØªÙ… ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ø·Ù„Ø¨ ÙƒÙ€ Â«Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©Â». Ù…ØªØ§Ø¨Ø¹Ø©ØŸ');">
                {% csrf_token %}
                <input type="hidden" name="state" value="awaiting_review">
                <button class="btn btn-secondary btn-xs">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</button>
              </form>
              <form method="post" action="{% url 'marketplace:request_change_state' req.pk %}" class="inline"
                    onsubmit="return confirm('Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ Â«Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°Â»ØŸ');">
                {% csrf_token %}
                <input type="hidden" name="state" value="in_progress">
                <button class="btn btn-secondary btn-xs">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</button>
              </form>
            </div>
          {% endif %}

        </div>
      {% endif %}

    </div>

    <div class="p-6 space-y-6">

      {# ===== Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù… (admin-only) ===== #}
      {% if request.user.is_authenticated and request.user.role == 'admin' or request.user.is_authenticated and request.user.is_staff %}
        <div class="rounded-xl border bg-amber-50 dark:bg-amber-900/20 p-4">
          <div class="flex items-center justify-between gap-3">
            <div class="text-slate-800 dark:text-amber-200 font-semibold">Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù…</div>
          </div>
          <div class="mt-3 flex flex-wrap items-center gap-2">
            <form method="post" action="{% url 'marketplace:admin_request_reset_to_new' req.pk %}"
                  onsubmit="return confirm('Ø³ÙŠÙØ¹Ø§Ø¯ Ø§Ù„Ø·Ù„Ø¨ ÙƒØ¬Ø¯ÙŠØ¯: Ø³ÙŠØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¥Ø³Ù†Ø§Ø¯ ÙˆØ±ÙØ¶ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ù„Ø£Ø±Ø´ÙØ©. ØªØ£ÙƒÙŠØ¯ØŸ');">
              {% csrf_token %}
              <button class="px-3 py-2 rounded-lg border bg-white dark:bg-slate-900 hover:bg-slate-50 dark:hover:bg-slate-800">Ø¥Ø±Ø¬Ø§Ø¹ ÙƒØ¬Ø¯ÙŠØ¯</button>
            </form>

            <a class="px-3 py-2 rounded-lg border bg-white dark:bg-slate-900 hover:bg-slate-50 dark:hover:bg-slate-800"
               href="{% url 'marketplace:admin_request_reassign' req.pk %}">
              Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø³Ù†Ø§Ø¯ Ù„Ù…ÙˆØ¸Ù Ø¢Ø®Ø±
            </a>

            <form method="post" action="{% url 'marketplace:admin_request_delete' req.pk %}"
                  onsubmit="return confirm('Ø³ÙŠØªÙ… Ø´Ø·Ø¨ Ø§Ù„Ø·Ù„Ø¨ Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹. ØªØ£ÙƒÙŠØ¯ØŸ');">
              {% csrf_token %}
              <button class="px-3 py-2 rounded-lg bg-rose-600 text-white hover:bg-rose-700">Ø´Ø·Ø¨ Ù†Ù‡Ø§Ø¦ÙŠ</button>
            </form>
          </div>
          <p class="text-xs text-slate-600 dark:text-slate-400 mt-2">Ù‡Ø°Ù‡ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ù…ØªØ§Ø­Ø© Ù„Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù… ÙÙ‚Ø·.</p>
        </div>
      {% endif %}

      {# ğŸŸ¦ ØªÙ‚Ø¯ÙŠÙ… Ø¹Ø±Ø¶ (Ù…ÙˆØ¸Ù Ù„Ù… ÙŠÙ‚Ø¯Ù‘Ù… Ø¹Ø±Ø¶Ù‹Ø§ Ø¨Ø¹Ø¯) #}
      {% if can_offer %}
      <div class="rounded-xl border bg-indigo-50 dark:bg-indigo-900/20 p-4">
        <div class="flex items-center justify-between gap-3">
          <div class="text-slate-700 dark:text-slate-200 text-sm">
            ÙŠÙ…ÙƒÙ†Ùƒ ØªÙ‚Ø¯ÙŠÙ… <b>Ø¹Ø±Ø¶ ÙˆØ§Ø­Ø¯ ÙÙ‚Ø·</b> Ù„Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨. Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠØ©: Ø¬Ø¯ÙŠØ¯.
          </div>
          <a class="px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 focus:ring-2 focus:ring-offset-1 focus:ring-indigo-500"
             href="{% url 'marketplace:offer_create_cbv' req.pk %}">
            ØªÙ‚Ø¯ÙŠÙ… Ø¹Ø±Ø¶
          </a>
        </div>
      </div>
      {% elif my_offer %}
      <div class="rounded-xl border bg-slate-50 dark:bg-slate-900/40 p-4">
        <div class="flex items-center justify-between gap-3">
          <div class="min-w-0">
            <div class="text-slate-900 dark:text-white font-bold truncate">Ø¹Ø±Ø¶Ùƒ Ø§Ù„Ù…Ù‚Ø¯Ù…</div>
            <div class="text-slate-500 dark:text-slate-400 text-sm truncate">
              Ø§Ù„Ø­Ø§Ù„Ø©: {{ my_offer.get_status_display|default:my_offer.status }} â€” Ø§Ù„Ù…Ø¯Ø©: {{ my_offer.proposed_duration_days }} â€” Ø§Ù„Ù…Ø¨Ù„Øº: {{ my_offer.proposed_price }}
            </div>
          </div>
          <span class="px-2 py-1 rounded-lg text-xs border bg-white dark:bg-slate-900 text-slate-700 dark:text-slate-300">Ù‚Ø¯Ù‘Ù…Øª Ø¹Ø±Ø¶Ù‹Ø§ Ø¨Ø§Ù„ÙØ¹Ù„</span>
        </div>
      </div>
      {% endif %}

      {# Ø¨Ø·Ø§Ù‚Ø§Øª Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø³Ø±ÙŠØ¹Ø© #}
      <div class="grid sm:grid-cols-2 gap-4">

        {# Ø§Ù„Ù…Ø¯Ø©/Ø§Ù„Ù…Ø¨Ù„Øº #}
        <div class="p-4 rounded-xl border bg-white dark:bg-slate-800">
          <div class="text-slate-500 dark:text-slate-400 text-sm mb-2">Ø§Ù„Ù…Ø¯Ø©/Ø§Ù„Ù…Ø¨Ù„Øº</div>
          <div class="grid grid-cols-1 gap-3">
            <div class="rounded-lg border border-sky-200 dark:border-sky-900 bg-sky-50 dark:bg-sky-900/20 p-3">
              <div class="text-xs text-sky-700 dark:text-sky-300 mb-1">Ù…Ù‚Ø¯Ù‘Ù…Ø© Ù…Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„</div>
              <div class="flex items-center gap-4 text-slate-800 dark:text-slate-100">
                <div>Ø§Ù„Ù…Ø¯Ø©: <b>{{ req.estimated_duration_days|default:"â€”" }}</b> ÙŠÙˆÙ…</div>
                <div>Ø§Ù„Ù…Ø¨Ù„Øº: <b>{{ req.estimated_price|default:"â€”" }}</b> <span class="text-xs text-slate-500">Ø±ÙŠØ§Ù„</span></div>
              </div>
            </div>

            {% if req.selected_offer %}
            <div class="rounded-lg border border-amber-200 dark:border-amber-900 bg-amber-50 dark:bg-amber-900/20 p-3">
              <div class="text-xs text-amber-800 dark:text-amber-200 mb-1">Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®ØªØ§Ø±</div>
              <div class="flex items-center gap-4 text-slate-800 dark:text-slate-100">
                <div>Ø§Ù„Ù…Ø¯Ø©: <b>{{ req.selected_offer.proposed_duration_days }}</b> ÙŠÙˆÙ…</div>
                <div>Ø§Ù„Ù…Ø¨Ù„Øº: <b>{{ req.selected_offer.proposed_price }}</b> <span class="text-xs text-slate-500">Ø±ÙŠØ§Ù„</span></div>
              </div>
            </div>
            {% endif %}

            {% if req.agreement %}
            <div class="rounded-lg border border-emerald-200 dark:border-emerald-900 bg-emerald-50 dark:bg-emerald-900/20 p-3">
              <div class="text-xs text-emerald-800 dark:text-emerald-200 mb-1">Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ©</div>
              <div class="flex items-center gap-4 text-slate-800 dark:text-slate-100">
                <div>Ø§Ù„Ù…Ø¯Ø©: <b>{{ req.agreement.duration_days }}</b> ÙŠÙˆÙ…</div>
                <div>Ø§Ù„Ù…Ø¨Ù„Øº: <b>{{ req.agreement.total_amount }}</b> <span class="text-xs text-slate-500">Ø±ÙŠØ§Ù„</span></div>
              </div>
            </div>
            {% endif %}
          </div>
        </div>

        {# Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…Ø³Ù†Ø¯ #}
        <div class="rounded-xl border p-4 bg-slate-50 dark:bg-slate-900/40">
          <div class="font-bold text-slate-800 dark:text-white mb-1">Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…Ø³Ù†Ø¯</div>
          <div class="text-slate-700 dark:text-slate-200">
            {% if req.assigned_employee %}
              {{ req.assigned_employee }}
            {% elif req.selected_offer %}
              {{ req.selected_offer.employee }}
            {% else %}
              â€” Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¥Ø³Ù†Ø§Ø¯ Ø¨Ø¹Ø¯ â€”
            {% endif %}
          </div>
        </div>
      </div>

      {# ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ #}
      <div class="rounded-xl border bg-white dark:bg-slate-800 p-4">
        <div class="text-slate-500 dark:text-slate-400 text-sm mb-2">Ø§Ù„ØªÙØ§ØµÙŠÙ„</div>
        <div class="prose prose-slate dark:prose-invert max-w-none whitespace-pre-line text-slate-800 dark:text-slate-100">
          {{ req.details|default:"â€”"|urlize|linebreaksbr }}
        </div>
      </div>

      {% if req.links %}
      <div class="rounded-xl border bg-white dark:bg-slate-800 p-4">
        <div class="text-slate-500 dark:text-slate-400 text-sm mb-2">Ø±ÙˆØ§Ø¨Ø· Ù…Ø±ØªØ¨Ø·Ø©</div>
        <div class="whitespace-pre-line text-slate-800 dark:text-slate-100">
          {{ req.links|urlize|linebreaksbr }}
        </div>
      </div>
      {% endif %}

      {# ===== Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙˆØ§ØµÙ„ (Ø¨Ø¹Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø¹Ø±Ø¶) ===== #}
      {% if req.status != 'new' %}
      <div class="rounded-2xl border bg-white dark:bg-slate-800 p-4">
        <div class="flex items-center justify-between mb-4">
          <div class="text-slate-800 dark:text-white font-bold">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙˆØ§ØµÙ„</div>
          <div class="text-xs text-slate-500 dark:text-slate-400">ØªØ¸Ù‡Ø± Ø¨Ø¹Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø¹Ø±Ø¶ Ù…Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„</div>
        </div>

        <div class="grid md:grid-cols-2 gap-4">
          <div class="rounded-xl border p-4 bg-slate-50 dark:bg-slate-900/40">
            <div class="font-semibold text-slate-800 dark:text-white mb-2">Ø§Ù„Ø¹Ù…ÙŠÙ„</div>
            <div class="space-y-2 text-slate-700 dark:text-slate-200">
              <div>Ø§Ù„Ø§Ø³Ù…: <b>{{ req.client }}</b></div>
              {% if req.client.phone %}
              <div class="flex items-center gap-2">
                <span>Ø§Ù„Ø¬ÙˆØ§Ù„:</span>
                <a class="text-indigo-700 dark:text-indigo-300 hover:underline" dir="ltr" href="tel:{{ req.client.phone }}">{{ req.client.phone }}</a>
                <a class="text-emerald-700 dark:text-emerald-300 hover:underline" target="_blank" rel="noopener noreferrer"
                   href="https://api.whatsapp.com/send?phone={{ req.client.phone|urlencode }}">ÙˆØ§ØªØ³Ø§Ø¨</a>
              </div>
              {% endif %}
              {% if req.client.email %}
              <div>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„:
                <a class="text-indigo-700 dark:text-indigo-300 hover:underline" href="mailto:{{ req.client.email|urlencode }}">
                  {{ req.client.email }}
                </a>
              </div>
              {% endif %}
            </div>
          </div>

          {% if req.assigned_employee or req.selected_offer %}
          <div class="rounded-xl border p-4 bg-slate-50 dark:bg-slate-900/40">
            <div class="font-semibold text-slate-800 dark:text-white mb-2">Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…Ø³Ù†Ø¯</div>
            <div class="space-y-2 text-slate-700 dark:text-slate-200">
              <div>Ø§Ù„Ø§Ø³Ù…:
                <b>
                  {% if req.assigned_employee %}{{ req.assigned_employee }}{% else %}{{ req.selected_offer.employee }}{% endif %}
                </b>
              </div>

              {% if req.assigned_employee and req.assigned_employee.phone %}
              <div class="flex items-center gap-2">
                <span>Ø§Ù„Ø¬ÙˆØ§Ù„:</span>
                <a class="text-indigo-700 dark:text-indigo-300 hover:underline" dir="ltr" href="tel:{{ req.assigned_employee.phone }}">{{ req.assigned_employee.phone }}</a>
                <a class="text-emerald-700 dark:text-emerald-300 hover:underline" target="_blank" rel="noopener noreferrer"
                   href="https://api.whatsapp.com/send?phone={{ req.assigned_employee.phone|urlencode }}">ÙˆØ§ØªØ³Ø§Ø¨</a>
              </div>
              {% elif req.selected_offer and req.selected_offer.employee and req.selected_offer.employee.phone %}
              <div class="flex items-center gap-2">
                <span>Ø§Ù„Ø¬ÙˆØ§Ù„:</span>
                <a class="text-indigo-700 dark:text-indigo-300 hover:underline" dir="ltr" href="tel:{{ req.selected_offer.employee.phone }}">{{ req.selected_offer.employee.phone }}</a>
                <a class="text-emerald-700 dark:text-emerald-300 hover:underline" target="_blank" rel="noopener noreferrer"
                   href="https://api.whatsapp.com/send?phone={{ req.selected_offer.employee.phone|urlencode }}">ÙˆØ§ØªØ³Ø§Ø¨</a>
              </div>
              {% endif %}

              {% if req.assigned_employee and req.assigned_employee.email %}
              <div>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„:
                <a class="text-indigo-700 dark:text-indigo-300 hover:underline" href="mailto:{{ req.assigned_employee.email|urlencode }}">
                  {{ req.assigned_employee.email }}
                </a>
              </div>
              {% elif req.selected_offer and req.selected_offer.employee and req.selected_offer.employee.email %}
              <div>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„:
                <a class="text-indigo-700 dark:text-indigo-300 hover:underline" href="mailto:{{ req.selected_offer.employee.email|urlencode }}">
                  {{ req.selected_offer.employee.email }}
                </a>
              </div>
              {% endif %}
            </div>
          </div>
          {% endif %}
        </div>
      </div>
      {% endif %}

      {# Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª #}
      <div class="rounded-xl border bg-white dark:bg-slate-800 p-4">
        <div class="flex items-center justify-between mb-3">
          <div class="text-slate-500 dark:text-slate-400 text-sm">Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</div>
        </div>

        <div class="space-y-3">
          {% for n in req.notes.all %}
          <div class="rounded-lg border bg-slate-50 dark:bg-slate-900/40 p-3">
            <div class="text-xs text-slate-500 dark:text-slate-400 mb-1">{{ n.author }} â€” {{ n.created_at|date:"Y-m-d H:i" }}</div>
            <div class="text-slate-800 dark:text-slate-100 whitespace-pre-line">{{ n.text }}</div>
          </div>
          {% empty %}
          <div class="text-slate-500 dark:text-slate-400 text-sm">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¨Ø¹Ø¯.</div>
          {% endfor %}
        </div>

        <form class="mt-4" method="post" action="{% url 'marketplace:request_add_note' req.pk %}"
              onsubmit="return confirm('Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨. ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ØŸ');">
          {% csrf_token %}
          <div class="grid gap-2 sm:grid-cols-[1fr_auto]">
            <textarea name="text" rows="2" class="input" placeholder="Ø£Ø¶Ù Ù…Ù„Ø§Ø­Ø¸Ø©"></textarea>
            <button class="btn btn-primary">Ø­ÙØ¸</button>
          </div>
        </form>
      </div>

      {# Ø§Ù„Ø¹Ø±ÙˆØ¶ #}
      <div class="rounded-xl border bg-white dark:bg-slate-800 p-4">
        <div class="flex items-center justify-between mb-3">
          <div class="text-slate-500 dark:text-slate-400 text-sm">Ø§Ù„Ø¹Ø±ÙˆØ¶</div>
        </div>

        <div class="space-y-3">
          {% for off in req.offers.all %}
          <div class="rounded-lg border p-3 {% if off.status == 'selected' %}bg-green-50 border-green-200 dark:bg-emerald-900/20 dark:border-emerald-900{% else %}bg-slate-50 dark:bg-slate-900/40{% endif %}">
            <div class="flex items-start justify-between gap-3">
              <div class="min-w-0">
                <div class="text-slate-900 dark:text-white font-bold">{{ off.employee }}</div>
                <div class="text-slate-600 dark:text-slate-300 text-sm mt-1">
                  Ø§Ù„Ø­Ø§Ù„Ø©: {{ off.get_status_display|default:off.status }}
                </div>
                {% if off.note %}
                <div class="mt-2 text-slate-800 dark:text-slate-100 whitespace-pre-line">
                  {{ off.note|urlize|linebreaksbr }}
                </div>
                {% endif %}
                <div class="mt-2 flex flex-wrap items-center gap-3 text-sm">
                  <span class="px-2 py-1 rounded-lg border bg-white dark:bg-slate-900 text-slate-700 dark:text-slate-300">Ø§Ù„Ù…Ø¯Ø©: <b>{{ off.proposed_duration_days }}</b> ÙŠÙˆÙ…</span>
                  <span class="px-2 py-1 rounded-lg border bg-white dark:bg-slate-900 text-slate-700 dark:text-slate-300">Ø§Ù„Ù…Ø¨Ù„Øº: <b>{{ off.proposed_price }}</b> Ø±ÙŠØ§Ù„</span>
                </div>
              </div>

              <div class="shrink-0">
                {% if req.client_id == request.user.id and req.status == 'new' and off.status != 'selected' %}
                  <form method="post" action="{% url 'marketplace:offer_select' off.pk %}"
                        onsubmit="return confirm('Ø³ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø±Ø¶ ÙˆØ§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ©. ØªØ£ÙƒÙŠØ¯ØŸ');">
                    {% csrf_token %}
                    <button class="btn btn-primary">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ø±Ø¶</button>
                  </form>
                {% elif off.status == 'selected' %}
                  <span class="px-2 py-1 rounded-lg text-xs bg-green-100 text-green-800 border border-green-200">Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®ØªØ§Ø±</span>
                {% endif %}
              </div>
            </div>
          </div>
          {% empty %}
          <div class="text-slate-500 dark:text-slate-400 text-sm">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ø±ÙˆØ¶ Ø¨Ø¹Ø¯.</div>
          {% endfor %}
        </div>
      </div>

      {# ===== Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ© ===== #}
      {% if req.agreement %}
        <div class="rounded-xl border bg-white dark:bg-slate-800 p-4">
          <div class="flex items-center justify-between mb-3">
            <div class="text-slate-500 dark:text-slate-400 text-sm">Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ©</div>
            <div class="flex items-center gap-2">
              <span class="px-2 py-1 rounded-lg text-xs bg-slate-100 dark:bg-slate-900 border text-slate-700 dark:text-slate-300">Ø±Ù‚Ù…: {{ req.agreement.pk }}</span>
              {% if req.agreement.status %}
                <span class="px-2 py-1 rounded-lg text-xs border
                            {% if req.agreement.status == 'accepted' %}bg-green-50 text-green-800 border-green-200 dark:bg-emerald-900/20 dark:text-emerald-200 dark:border-emerald-900
                            {% elif req.agreement.status == 'rejected' %}bg-rose-50 text-rose-700 border-rose-200 dark:bg-rose-900/20 dark:text-rose-200 dark:border-rose-900
                            {% else %}bg-amber-50 text-amber-800 border-amber-200 dark:bg-amber-900/20 dark:text-amber-200 dark:border-amber-900{% endif %}">
                  {{ req.agreement.get_status_display|default:req.agreement.status }}
                </span>
              {% endif %}
            </div>
          </div>

          <div class="flex flex-wrap items-center gap-3">
            <a class="btn btn-secondary" href="{% url 'agreements:open_by_request' req.pk %}">Ø¹Ø±Ø¶/ØªØ­Ø±ÙŠØ± Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ©</a>

            {% if request.user.id == req.client_id %}
              {% if req.status == 'agreement_pending' or req.agreement.status == 'pending' %}
                <form action="{% url 'agreements:accept_by_request' req.pk %}" method="post" class="inline"
                      onsubmit="return confirm('Ø³ÙŠØªÙ… Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ© ÙˆØ§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„ØªÙ†ÙÙŠØ°. ØªØ£ÙƒÙŠØ¯ØŸ');">
                  {% csrf_token %}
                  <button class="btn btn-success">Ù…ÙˆØ§ÙÙ‚Ø©</button>
                </form>
                <a class="btn btn-danger" href="{% url 'agreements:reject_by_request' req.pk %}"
                   onclick="return confirm('Ø³ÙŠØªÙ… Ø±ÙØ¶ Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ');">Ø±ÙØ¶</a>
              {% endif %}
            {% endif %}

            {% if req.agreement.status == 'accepted' %}
              <span class="text-xs text-slate-500 dark:text-slate-400">Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ© Ù…Ù‚Ø¨ÙˆÙ„Ø© â€” Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§.</span>
            {% endif %}
          </div>
        </div>

        {# ===== Ø§Ù„Ø¯ÙØ¹Ø§Øª/Ø§Ù„Ù…Ø±Ø§Ø­Ù„ (Milestones) ===== #}
        {% with ag=req.agreement %}
        <div class="rounded-xl border bg-white dark:bg-slate-800 p-4">
          <div class="flex items-center justify-between mb-3">
            <div class="text-slate-500 dark:text-slate-400 text-sm">Ø§Ù„Ø¯ÙØ¹Ø§Øª</div>
            <div class="text-xs text-slate-500 dark:text-slate-400">ØªÙÙ†Ø´Ø£ Ø§Ù„ÙÙˆØ§ØªÙŠØ± ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¨Ø¹Ø¯ Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø¹Ù…ÙŠÙ„</div>
          </div>

          <div class="space-y-4">
            {% for ms in ag.milestones.all %}
            <div id="ms-{{ ms.id }}" class="rounded-xl border p-4 bg-slate-50 dark:bg-slate-900/40 shadow-sm">
              <div class="flex flex-wrap items-start justify-between gap-3">
                <div class="min-w-0">
                  <div class="flex items-center gap-2 flex-wrap">
                    <div class="font-semibold text-slate-800 dark:text-white truncate">{{ ms.title }}</div>
                    <span class="px-2 py-0.5 rounded-lg text-[11px] border bg-white/70 dark:bg-slate-800/70 text-slate-700 dark:text-slate-300">#{{ ms.id }}</span>
                  </div>
                  <div class="text-sm text-slate-600 dark:text-slate-300 mt-1">
                    Ø§Ù„ØªØ±ØªÙŠØ¨: {{ ms.order }} â€”
                    Ø§Ù„Ù…Ù‡Ù„Ø©: {{ ms.due_days|default:"â€”" }} ÙŠÙˆÙ… â€”
                    Ø§Ù„Ù…Ø¨Ù„Øº: <b>{{ ms.amount }}</b> Ø±.Ø³
                  </div>

                  {% if ms.delivered_note %}
                    <div class="mt-2 text-xs text-slate-600 dark:text-slate-300">
                      <span class="font-semibold">Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„ØªØ³Ù„ÙŠÙ…:</span> {{ ms.delivered_note }}
                    </div>
                  {% endif %}
                  {% if ms.rejected_reason %}
                    <div class="mt-2 text-xs text-rose-600 dark:text-rose-300">
                      <span class="font-semibold">Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶:</span> {{ ms.rejected_reason }}
                    </div>
                  {% endif %}
                </div>

                <div class="flex items-center flex-wrap gap-2">
                  {% if ms.is_paid %}
                    <span class="px-2 py-1 rounded bg-emerald-100 text-emerald-700 dark:bg-emerald-900/20 dark:text-emerald-200 text-xs">Ù…Ø¯ÙÙˆØ¹Ø©</span>
                  {% elif ms.is_approved %}
                    <span class="px-2 py-1 rounded bg-emerald-100 text-emerald-700 dark:bg-emerald-900/20 dark:text-emerald-200 text-xs">Ù…Ø¹ØªÙ…Ø¯Ø©</span>
                  {% elif ms.is_rejected %}
                    <span class="px-2 py-1 rounded bg-rose-100 text-rose-700 dark:bg-rose-900/20 dark:text-rose-200 text-xs">Ù…Ø±ÙÙˆØ¶Ø©</span>
                  {% elif ms.is_pending_review %}
                    <span class="px-2 py-1 rounded bg-amber-100 text-amber-700 dark:bg-amber-900/20 dark:text-amber-200 text-xs">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„</span>
                  {% elif ms.is_delivered %}
                    <span class="px-2 py-1 rounded bg-sky-100 text-sky-700 dark:bg-sky-900/20 dark:text-sky-200 text-xs">ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</span>
                  {% else %}
                    <span class="px-2 py-1 rounded bg-slate-200 text-slate-700 dark:bg-slate-700 dark:text-slate-200 text-xs">Ø¬Ø¯ÙŠØ¯Ø©</span>
                  {% endif %}
                </div>
              </div>

              <div class="mt-4 flex flex-wrap items-start gap-3">

                {# Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…Ø³Ù†Ø¯: ØªØ³Ù„ÙŠÙ… Ø§Ù„Ù…Ø±Ø­Ù„Ø© #}
                {% if request.user.is_authenticated and request.user.id == req.assigned_employee_id %}
                  {% if not ms.is_approved and not ms.is_paid and not ms.is_rejected and not ms.is_pending_review and not ms.is_delivered %}
                    <form method="post" action="{% url 'agreements:milestone_deliver' ms.id %}#ms-{{ ms.id }}"
                          class="flex items-start gap-2"
                          onsubmit="return confirm('Ø³ÙŠØªÙ… ØªØ¹Ù„ÙŠÙ… Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø±Ø­Ù„Ø© ÙƒÙ€ (ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…) Ù…Ø¹ Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© Ø¥Ù† ÙˆÙØ¬Ø¯Øª. ØªØ£ÙƒÙŠØ¯ØŸ');">
                      {% csrf_token %}
                      <textarea name="note" rows="2" class="input !p-2 !text-xs" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„ØªØ³Ù„ÙŠÙ… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></textarea>
                      <button class="btn btn-secondary">ØªØ³Ù„ÙŠÙ… Ø§Ù„Ù…Ø±Ø­Ù„Ø©</button>
                    </form>
                  {% else %}
                    <button class="btn btn-secondary opacity-60 cursor-not-allowed" disabled title="Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ³Ù„ÙŠÙ… Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯/Ø§Ù„Ø±ÙØ¶/Ø§Ù„Ø³Ø¯Ø§Ø¯ Ø£Ùˆ Ø¹Ù†Ø¯ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©">ØªØ³Ù„ÙŠÙ… Ø§Ù„Ù…Ø±Ø­Ù„Ø©</button>
                  {% endif %}
                {% endif %}

                {# Ø§Ù„Ø¹Ù…ÙŠÙ„: Ø§Ø¹ØªÙ…Ø§Ø¯ Ø£Ùˆ Ø±ÙØ¶ #}
                {% if request.user.is_authenticated and request.user.id == req.client_id %}
                  {% if ms.is_pending_review %}
                    <form method="post" action="{% url 'agreements:milestone_approve' ms.id %}#ms-{{ ms.id }}"
                          onsubmit="return confirm('Ø³ÙŠØªÙ… Ø§Ø¹ØªÙ…Ø§Ø¯ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø±Ø­Ù„Ø© ÙˆØ§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„ÙØ§ØªÙˆØ±Ø©. ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ØŸ');">
                      {% csrf_token %}
                      <button class="btn btn-success">Ø§Ø¹ØªÙ…Ø§Ø¯</button>
                    </form>

                    <button class="btn btn-danger" data-reject-modal="#rej-{{ ms.id }}">Ø±ÙØ¶</button>

                    {# Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø±ÙØ¶ #}
                    <div id="rej-{{ ms.id }}" class="fixed inset-0 z-50 hidden">
                      <div class="absolute inset-0 bg-black/40" data-close-modal></div>
                      <div class="mx-auto mt-24 w-[92%] max-w-lg rounded-2xl border bg-white dark:bg-slate-800 shadow-xl overflow-hidden">
                        <div class="p-4 border-b bg-rose-50 dark:bg-rose-900/20">
                          <div class="font-semibold text-rose-700 dark:text-rose-200">Ø±ÙØ¶ Ø§Ù„Ù…Ø±Ø­Ù„Ø©: {{ ms.title }}</div>
                        </div>
                        <form method="post" action="{% url 'agreements:milestone_reject' ms.id %}#ms-{{ ms.id }}"
                              onsubmit="return confirm('Ø³ÙŠØªÙ… Ø±ÙØ¶ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ù…Ø¹ Ø§Ù„Ø³Ø¨Ø¨ Ø§Ù„Ù…Ø¯Ø®Ù„. ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø±ÙØ¶ØŸ');">
                          {% csrf_token %}
                          <div class="p-4 space-y-3">
                            <label class="text-sm text-slate-700 dark:text-slate-200">Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶</label>
                            <textarea name="reason" rows="3" class="input" placeholder="ÙØ¶Ù„Ø§Ù‹ Ø§ÙƒØªØ¨ Ø³Ø¨Ø¨Ù‹Ø§ ÙˆØ§Ø¶Ø­Ù‹Ø§ (3 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)"></textarea>
                            <p class="text-xs text-slate-500 dark:text-slate-400">Ù„Ù† ÙŠØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø±ÙØ¶ Ø¨Ø¯ÙˆÙ† Ø³Ø¨Ø¨ ÙˆØ§Ø¶Ø­.</p>
                          </div>
                          <div class="p-4 border-t flex items-center justify-end gap-2">
                            <button type="button" class="btn btn-ghost" data-close-modal>Ø¥Ù„ØºØ§Ø¡</button>
                            <button class="btn btn-danger">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø±ÙØ¶</button>
                          </div>
                        </form>
                      </div>
                    </div>
                  {% else %}
                    <button class="btn btn-success opacity-60 cursor-not-allowed" disabled title="Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø¢Ù†">Ø§Ø¹ØªÙ…Ø§Ø¯</button>
                    <button class="btn btn-danger opacity-60 cursor-not-allowed" disabled title="Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø±ÙØ¶ Ø§Ù„Ø¢Ù†">Ø±ÙØ¶</button>
                  {% endif %}
                {% endif %}

                {# Ø±Ø§Ø¨Ø· Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¥Ù† ÙˆÙØ¬Ø¯Øª #}
                {% if ms.invoice %}
                  <a href="{% url 'finance:invoice_detail' ms.invoice.id %}" class="btn btn-ghost">Ø¹Ø±Ø¶ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</a>
                {% endif %}

              </div>
            </div>
            {% empty %}
              <div class="text-slate-500 dark:text-slate-400 text-sm">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙØ¹Ø§Øª Ø¨Ø¹Ø¯.</div>
            {% endfor %}
          </div>
        </div>
        {% endwith %}
      {% else %}
        {% if req.status == 'offer_selected' %}
          {% if request.user.id == req.assigned_employee_id or request.user.is_staff or request.user.role == 'admin' %}
            <div class="rounded-xl border bg-white dark:bg-slate-800 p-4">
              <div class="flex items-center justify-between mb-3">
                <div class="text-slate-500 dark:text-slate-400 text-sm">Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ©</div>
              </div>
              <a class="px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 focus:ring-2 focus:ring-offset-1 focus:ring-indigo-500"
                 href="{% url 'agreements:open_by_request' req.pk %}">
                Ø¥Ù†Ø´Ø§Ø¡/ÙØªØ­ Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ©
              </a>
              <p class="mt-2 text-xs text-slate-500 dark:text-slate-400">ÙŠÙ…ÙƒÙ† Ù„Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…Ø³Ù†Ø¯ Ø£Ùˆ Ø§Ù„Ù…Ø¯ÙŠØ± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ© Ø¨Ø¹Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø¹Ø±Ø¶.</p>
            </div>
          {% endif %}
        {% endif %}
      {% endif %}

      {# Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª #}
      {% if uploads %}
      <div class="rounded-xl border bg-white dark:bg-slate-800 p-4">
        <div class="flex items-center justify-between mb-3">
          <div class="text-slate-500 dark:text-slate-400 text-sm">Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª</div>
        </div>
        <ul class="grid sm:grid-cols-2 lg:grid-cols-3 gap-3">
          {% for up in uploads %}
          <li id="up-{{ up.id }}" class="rounded-lg border bg-slate-50 dark:bg-slate-900/40 p-3">
            <div class="flex items-center justify-between gap-2">
              <a class="truncate text-indigo-700 dark:text-indigo-300 hover:underline" href="{{ up.file.url }}" target="_blank" rel="noopener noreferrer">ØªØ­Ù…ÙŠÙ„/Ø¹Ø±Ø¶</a>
              {% if up.can_delete %}
              <form method="post" action="{% url 'uploads:delete' up.id %}"
                    onsubmit="return confirm('Ø³ÙŠØªÙ… Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø±ÙÙ‚ Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§. Ù…ØªØ§Ø¨Ø¹Ø©ØŸ');">
                {% csrf_token %}
                <button class="text-rose-600 text-sm hover:underline">Ø­Ø°Ù</button>
              </form>
              {% endif %}
            </div>
            <div class="text-xs text-slate-500 dark:text-slate-400 mt-1">{{ up.created_at|date:"Y-m-d H:i" }}</div>
          </li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}

      {# Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© #}
      {% if thread_embed_url %}
      <div class="rounded-xl border bg-white dark:bg-slate-800 p-4">
        <div class="flex items-center justify-between mb-3">
          <div class="text-slate-500 dark:text-slate-400 text-sm">Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</div>
        </div>
        <iframe src="{{ thread_embed_url }}" class="w-full h-[540px] rounded-xl border"></iframe>
      </div>
      {% endif %}

    </div>
  </div>

</section>

{# Ø³ÙƒØ±Ø¨Øª ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ + Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªÙˆØ³ØªØ§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ #}
<script>
document.addEventListener('click', function(e) {
  const openBtn = e.target.closest('[data-reject-modal]');
  if (openBtn) {
    const sel = openBtn.getAttribute('data-reject-modal');
    const modal = document.querySelector(sel);
    if (modal) modal.classList.remove('hidden');
  }
  if (e.target.matches('[data-close-modal]')) {
    const modal = e.target.closest('.fixed.inset-0');
    if (modal) modal.classList.add('hidden');
  }
  const closeAlert = e.target.closest('[data-close-alert]');
  if (closeAlert) {
    const wrap = closeAlert.closest('.rounded-xl, .rounded-lg, .rounded-2xl');
    if (wrap) wrap.remove();
  }
});
setTimeout(function() {
  const msgs = document.querySelectorAll('#messages-area > *');
  msgs.forEach(function(el) {
    el.classList.add('transition', 'duration-500', 'ease-out');
    el.style.opacity = '0';
    setTimeout(function(){ el.remove(); }, 600);
  });
}, 4500);
</script>
{% endblock %}
