{% extends "base.html" %}
{% block title %}Ø·Ù„Ø¨ #{{ req.pk }}{% endblock %}
{% block content %}
<section class="py-8 max-w-6xl mx-auto rtl" dir="rtl">

  <div class="rounded-2xl border bg-white/80 backdrop-blur shadow-glass-lg overflow-hidden">

    <!-- ===== Header ===== -->
    <div class="p-6 border-b bg-gradient-to-l from-indigo-50 to-sky-50">
      <div class="flex items-start justify-between gap-6">
        <div class="min-w-0">
          <div class="flex items-center gap-2 flex-wrap">
            <!-- Ø¥Ø¨Ø±Ø§Ø² Ø§Ù„Ø¹Ù†ÙˆØ§Ù† -->
            <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight text-slate-900">
              {{ req.title }}
            </h1>
            <span class="px-2 py-1 rounded-lg text-xs border bg-white text-slate-700">#{{ req.pk }}</span>
            <span class="px-2 py-1 rounded-lg text-xs border bg-white text-slate-700">
              {{ req.get_status_display|default:req.status }}
            </span>
            {% if req.agreement_overdue %}
              <span class="px-2 py-1 rounded-lg text-xs bg-red-50 text-red-700 border border-red-200">ØªØ¬Ø§ÙˆØ²Øª Ù…Ù‡Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ©</span>
            {% endif %}
          </div>
          <p class="text-slate-600 text-sm mt-2">
            Ø§Ù„Ø¹Ù…ÙŠÙ„: <b>{{ req.client }}</b>
            {% if req.assigned_employee %} â€” Ø§Ù„Ù…ÙˆØ¸Ù: <b>{{ req.assigned_employee }}</b>{% endif %}
          </p>
        </div>
        <div class="text-slate-500 text-sm shrink-0">
          Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: {{ req.updated_at|date:"Y-m-d H:i" }}
        </div>
      </div>
    </div>

    <div class="p-6 space-y-6">

      <!-- ===== Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù… (admin-only) ===== -->
      {% if request.user.is_authenticated %}
        {% if request.user.role == "admin" or request.user.is_staff %}
        <div class="rounded-xl border bg-amber-50 p-4">
          <div class="flex items-center justify-between gap-3">
            <div class="text-slate-800 font-semibold">Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù…</div>
          </div>
          <div class="mt-3 flex flex-wrap items-center gap-2">

            <!-- Ø¥Ø±Ø¬Ø§Ø¹ ÙƒØ¬Ø¯ÙŠØ¯ -->
            <form method="post" action="{% url 'marketplace:admin_request_reset_to_new' req.pk %}"
                  onsubmit="return confirm('Ø³ÙŠÙØ¹Ø§Ø¯ Ø§Ù„Ø·Ù„Ø¨ ÙƒØ¬Ø¯ÙŠØ¯: Ø³ÙŠØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¥Ø³Ù†Ø§Ø¯ ÙˆØ±ÙØ¶ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ù„Ø£Ø±Ø´ÙØ©. ØªØ£ÙƒÙŠØ¯ØŸ');">
              {% csrf_token %}
              <button class="px-3 py-2 rounded-lg border bg-white hover:bg-slate-50">Ø¥Ø±Ø¬Ø§Ø¹ ÙƒØ¬Ø¯ÙŠØ¯</button>
            </form>

            <!-- Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø³Ù†Ø§Ø¯ Ù„Ù…ÙˆØ¸Ù Ø¢Ø®Ø± -->
            <a class="px-3 py-2 rounded-lg border bg-white hover:bg-slate-50"
               href="{% url 'marketplace:admin_request_reassign' req.pk %}">
              Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø³Ù†Ø§Ø¯ Ù„Ù…ÙˆØ¸Ù Ø¢Ø®Ø±
            </a>

            <!-- Ø´Ø·Ø¨ Ù†Ù‡Ø§Ø¦ÙŠ -->
            <form method="post" action="{% url 'marketplace:admin_request_delete' req.pk %}"
                  onsubmit="return confirm('Ø³ÙŠØªÙ… Ø´Ø·Ø¨ Ø§Ù„Ø·Ù„Ø¨ Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹. ØªØ£ÙƒÙŠØ¯ØŸ');">
              {% csrf_token %}
              <button class="px-3 py-2 rounded-lg bg-rose-600 text-white hover:bg-rose-700">Ø´Ø·Ø¨ Ù†Ù‡Ø§Ø¦ÙŠ</button>
            </form>

          </div>
          <p class="text-xs text-slate-600 mt-2">Ù‡Ø°Ù‡ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ù…ØªØ§Ø­Ø© Ù„Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù… ÙÙ‚Ø·.</p>
        </div>
        {% endif %}
      {% endif %}

      <!-- ğŸŸ¦ ØªÙ‚Ø¯ÙŠÙ… Ø¹Ø±Ø¶ (ØªÙ†Ø¨ÙŠÙ‡: Ø¹Ø±Ø¶ ÙˆØ§Ø­Ø¯ ÙÙ‚Ø·) -->
      {% if can_offer %}
      <div class="rounded-xl border bg-indigo-50 p-4">
        <div class="flex items-center justify-between gap-3">
          <div class="text-slate-700 text-sm">
            ÙŠÙ…ÙƒÙ†Ùƒ ØªÙ‚Ø¯ÙŠÙ… <b>Ø¹Ø±Ø¶ ÙˆØ§Ø­Ø¯ ÙÙ‚Ø·</b> Ù„Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨. Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠØ©: Ø¬Ø¯ÙŠØ¯.
          </div>
          <!-- Ø§Ø³ØªØ®Ø¯Ù…Ù†Ø§ Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù…ÙØ­Ø¯Ù‘Ø«: offer_create_cbv -->
          <a class="px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 focus:ring-2 focus:ring-offset-1 focus:ring-indigo-500"
             href="{% url 'marketplace:offer_create_cbv' req.pk %}">
            ØªÙ‚Ø¯ÙŠÙ… Ø¹Ø±Ø¶
          </a>
        </div>
      </div>
      {% elif my_offer %}
      <div class="rounded-xl border bg-slate-50 p-4">
        <div class="flex items-center justify-between gap-3">
          <div class="min-w-0">
            <div class="text-slate-900 font-bold truncate">Ø¹Ø±Ø¶Ùƒ Ø§Ù„Ù…Ù‚Ø¯Ù…</div>
            <div class="text-slate-500 text-sm truncate">
              Ø§Ù„Ø­Ø§Ù„Ø©: {{ my_offer.get_status_display|default:my_offer.status }} â€” Ø§Ù„Ù…Ø¯Ø©: {{ my_offer.proposed_duration_days }} â€” Ø§Ù„Ù…Ø¨Ù„Øº: {{ my_offer.proposed_price }}
            </div>
          </div>
          <span class="px-2 py-1 rounded-lg text-xs border bg-white text-slate-700">Ù‚Ø¯Ù‘Ù…Øª Ø¹Ø±Ø¶Ù‹Ø§ Ø¨Ø§Ù„ÙØ¹Ù„</span>
        </div>
      </div>
      {% endif %}

      <!-- Ø¨Ø·Ø§Ù‚Ø§Øª Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø³Ø±ÙŠØ¹Ø©: ØªÙ…ÙŠÙŠØ² Ù‚ÙŠÙ… Ø§Ù„Ø¹Ù…ÙŠÙ„ -->
      <div class="grid sm:grid-cols-2 gap-4">

        <!-- Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø¯Ø©/Ø§Ù„Ù…Ø¨Ù„Øº (Ù†ÙØ¨Ø±Ø² Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹) -->
        <div class="p-4 rounded-xl border bg-white">
          <div class="text-slate-500 text-sm mb-2">Ø§Ù„Ù…Ø¯Ø©/Ø§Ù„Ù…Ø¨Ù„Øº</div>

          <div class="grid grid-cols-1 gap-3">
            <!-- Ù‚ÙŠÙ… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¨Ø¯Ø¦ÙŠØ© -->
            <div class="rounded-lg border border-sky-200 bg-sky-50 p-3">
              <div class="text-xs text-sky-700 mb-1">Ù…Ù‚Ø¯Ù‘Ù…Ø© Ù…Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„</div>
              <div class="flex items-center gap-4 text-slate-800">
                <div>Ø§Ù„Ù…Ø¯Ø©: <b>{{ req.estimated_duration_days|default:"â€”" }}</b> ÙŠÙˆÙ…</div>
                <div>Ø§Ù„Ù…Ø¨Ù„Øº: <b>{{ req.estimated_price|default:"â€”" }}</b> <span class="text-xs text-slate-500">Ø±ÙŠØ§Ù„</span></div>
              </div>
            </div>

            <!-- Ø¥Ù† ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø¹Ø±Ø¶ Ù…Ø®ØªØ§Ø± -->
            {% if req.selected_offer %}
            <div class="rounded-lg border border-amber-200 bg-amber-50 p-3">
              <div class="text-xs text-amber-800 mb-1">Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®ØªØ§Ø±</div>
              <div class="flex items-center gap-4 text-slate-800">
                <div>Ø§Ù„Ù…Ø¯Ø©: <b>{{ req.selected_offer.proposed_duration_days }}</b> ÙŠÙˆÙ…</div>
                <div>Ø§Ù„Ù…Ø¨Ù„Øº: <b>{{ req.selected_offer.proposed_price }}</b> <span class="text-xs text-slate-500">Ø±ÙŠØ§Ù„</span></div>
              </div>
            </div>
            {% endif %}

            <!-- Ø¥Ù† ÙˆÙØ¬Ø¯Øª Ø§ØªÙØ§Ù‚ÙŠØ© -->
            {% if req.agreement %}
            <div class="rounded-lg border border-emerald-200 bg-emerald-50 p-3">
              <div class="text-xs text-emerald-800 mb-1">Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ©</div>
              <div class="flex items-center gap-4 text-slate-800">
                <div>Ø§Ù„Ù…Ø¯Ø©: <b>{{ req.agreement.duration_days }}</b> ÙŠÙˆÙ…</div>
                <div>Ø§Ù„Ù…Ø¨Ù„Øº: <b>{{ req.agreement.total_amount }}</b> <span class="text-xs text-slate-500">Ø±ÙŠØ§Ù„</span></div>
              </div>
            </div>
            {% endif %}
          </div>
        </div>

        <!-- Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…Ø³Ù†Ø¯ -->
        <div class="rounded-xl border p-4 bg-slate-50">
          <div class="font-bold text-slate-800 mb-1">Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…Ø³Ù†Ø¯</div>
          <div class="text-slate-700">
            {% if req.assigned_employee %}
              {{ req.assigned_employee }}
            {% elif req.selected_offer %}
              {{ req.selected_offer.employee }}
            {% else %}
              â€” Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¥Ø³Ù†Ø§Ø¯ Ø¨Ø¹Ø¯ â€”
            {% endif %}
          </div>
        </div>
      </div>

      <!-- ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ (ÙƒÙ…Ø§ ÙƒØªØ¨Ù‡Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ø§Ù„Ø£Ø³Ø·Ø±) -->
      <div class="rounded-xl border bg-white p-4">
        <div class="text-slate-500 text-sm mb-2">Ø§Ù„ØªÙØ§ØµÙŠÙ„</div>
        <div class="prose prose-slate max-w-none whitespace-pre-line text-slate-800">
          {{ req.details|default:"â€”"|urlize|linebreaksbr }}
        </div>
      </div>

      <!-- Ø§Ù„Ø±ÙˆØ§Ø¨Ø· -->
      {% if req.links %}
      <div class="rounded-xl border bg-white p-4">
        <div class="text-slate-500 text-sm mb-2">Ø±ÙˆØ§Ø¨Ø· Ù…Ø±ØªØ¨Ø·Ø©</div>
        <div class="whitespace-pre-line text-slate-800">{{ req.links|urlize|linebreaksbr }}</div>
      </div>
      {% endif %}

      <!-- ===================== Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙˆØ§ØµÙ„ (ØªØ¸Ù‡Ø± ÙÙ‚Ø· Ø¨Ø¹Ø¯ Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø¹Ø±Ø¶) ===================== -->
      {% if req.status != 'new' %}
      <div class="rounded-2xl border bg-white p-4">
        <div class="flex items-center justify-between mb-4">
          <div class="text-slate-800 font-bold">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙˆØ§ØµÙ„</div>
          <div class="text-xs text-slate-500">ØªØ¸Ù‡Ø± Ø¨Ø¹Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø¹Ø±Ø¶ Ù…Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„</div>
        </div>

        <div class="grid md:grid-cols-2 gap-4">

          <!-- Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„ -->
          <div class="rounded-xl border p-4 bg-slate-50">
            <div class="flex items-center gap-2 mb-2">
              <span class="i-lucide:user"></span>
              <div class="font-semibold text-slate-800">Ø§Ù„Ø¹Ù…ÙŠÙ„</div>
            </div>
            <div class="space-y-2 text-slate-700">
              <div>Ø§Ù„Ø§Ø³Ù…: <b>{{ req.client }}</b></div>
              {% if req.client.phone %}
              <div class="flex items-center gap-2">
                <span>Ø§Ù„Ø¬ÙˆØ§Ù„:</span>
                <a class="text-indigo-700 hover:underline" dir="ltr" href="tel:{{ req.client.phone }}">{{ req.client.phone }}</a>
                <a class="text-emerald-700 hover:underline" target="_blank" rel="noopener"
                   href="https://api.whatsapp.com/send?phone={{ req.client.phone|urlencode }}">ÙˆØ§ØªØ³Ø§Ø¨</a>
              </div>
              {% endif %}
              {% if req.client.email %}
              <div>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„:
                <a class="text-indigo-700 hover:underline" href="mailto:{% filter force_escape %}{{ req.client.email }}{% endfilter %}">
                  {{ req.client.email }}
                </a>
              </div>
              {% endif %}
            </div>
          </div>

          <!-- Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…Ø³Ù†Ø¯ -->
          {% if req.assigned_employee or req.selected_offer %}
          <div class="rounded-xl border p-4 bg-slate-50">
            <div class="flex items-center gap-2 mb-2">
              <span class="i-lucide:badge-check"></span>
              <div class="font-semibold text-slate-800">Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…Ø³Ù†Ø¯</div>
            </div>
            <div class="space-y-2 text-slate-700">
              <div>Ø§Ù„Ø§Ø³Ù…:
                <b>
                  {% if req.assigned_employee %}{{ req.assigned_employee }}{% else %}{{ req.selected_offer.employee }}{% endif %}
                </b>
              </div>
              {% if req.assigned_employee and req.assigned_employee.phone %}
              <div class="flex items-center gap-2">
                <span>Ø§Ù„Ø¬ÙˆØ§Ù„:</span>
                <a class="text-indigo-700 hover:underline" dir="ltr" href="tel:{{ req.assigned_employee.phone }}">{{ req.assigned_employee.phone }}</a>
                <a class="text-emerald-700 hover:underline" target="_blank" rel="noopener"
                   href="https://api.whatsapp.com/send?phone={{ req.assigned_employee.phone|urlencode }}">ÙˆØ§ØªØ³Ø§Ø¨</a>
              </div>
              {% elif req.selected_offer and req.selected_offer.employee and req.selected_offer.employee.phone %}
              <div class="flex items-center gap-2">
                <span>Ø§Ù„Ø¬ÙˆØ§Ù„:</span>
                <a class="text-indigo-700 hover:underline" dir="ltr" href="tel:{{ req.selected_offer.employee.phone }}">{{ req.selected_offer.employee.phone }}</a>
                <a class="text-emerald-700 hover:underline" target="_blank" rel="noopener"
                   href="https://api.whatsapp.com/send?phone={{ req.selected_offer.employee.phone|urlencode }}">ÙˆØ§ØªØ³Ø§Ø¨</a>
              </div>
              {% endif %}

              {% if req.assigned_employee and req.assigned_employee.email %}
              <div>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„:
                <a class="text-indigo-700 hover:underline" href="mailto:{% filter force_escape %}{{ req.assigned_employee.email }}{% endfilter %}">
                  {{ req.assigned_employee.email }}
                </a>
              </div>
              {% elif req.selected_offer and req.selected_offer.employee and req.selected_offer.employee.email %}
              <div>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„:
                <a class="text-indigo-700 hover:underline" href="mailto:{% filter force_escape %}{{ req.selected_offer.employee.email }}{% endfilter %}">
                  {{ req.selected_offer.employee.email }}
                </a>
              </div>
              {% endif %}
            </div>
          </div>
          {% endif %}

        </div>
      </div>
      {% endif %}
      <!-- ================================================================================ -->

      <!-- Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª -->
      <div class="rounded-xl border bg-white p-4">
        <div class="flex items-center justify-between mb-3">
          <div class="text-slate-500 text-sm">Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</div>
        </div>

        <div class="space-y-3">
          {% for n in req.notes.all %}
          <div class="rounded-lg border bg-slate-50 p-3">
            <div class="text-xs text-slate-500 mb-1">{{ n.author }} â€” {{ n.created_at|date:"Y-m-d H:i" }}</div>
            <div class="text-slate-800 whitespace-pre-line">{{ n.text }}</div>
          </div>
          {% empty %}
          <div class="text-slate-500 text-sm">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¨Ø¹Ø¯.</div>
          {% endfor %}
        </div>

        <form class="mt-4" method="post" action="{% url 'marketplace:request_add_note' req.pk %}">
          {% csrf_token %}
          <div class="grid gap-2 sm:grid-cols-[1fr_auto]">
            <textarea name="text" rows="2" class="input" placeholder="Ø£Ø¶Ù Ù…Ù„Ø§Ø­Ø¸Ø©"></textarea>
            <button class="btn btn-primary">Ø­ÙØ¸</button>
          </div>
        </form>
      </div>

      <!-- Ø§Ù„Ø¹Ø±ÙˆØ¶ (ØªÙØ§ØµÙŠÙ„ Ù„Ù„Ø¹Ù…ÙŠÙ„ Ù…Ø¹ Ù‚Ø¨ÙˆÙ„/Ø±ÙØ¶) -->
      <div class="rounded-xl border bg-white p-4">
        <div class="flex items-center justify-between mb-3">
          <div class="text-slate-500 text-sm">Ø§Ù„Ø¹Ø±ÙˆØ¶</div>
        </div>

        <div class="space-y-3">
          {% for off in req.offers.all %}
          <div class="rounded-lg border p-3 {% if off.status == 'selected' %}bg-green-50 border-green-200{% else %}bg-slate-50{% endif %}">
            <div class="flex items-start justify-between gap-3">
              <div class="min-w-0">
                <div class="text-slate-900 font-bold">{{ off.employee }}</div>
                <div class="text-slate-600 text-sm mt-1">
                  Ø§Ù„Ø­Ø§Ù„Ø©: {{ off.get_status_display|default:off.status }}
                </div>
                <!-- ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶ ÙƒÙ…Ø§ ÙƒØªØ¨Ù‡Ø§ Ø§Ù„Ù…ÙˆØ¸Ù -->
                {% if off.note %}
                <div class="mt-2 text-slate-800 whitespace-pre-line">
                  {{ off.note|urlize|linebreaksbr }}
                </div>
                {% endif %}
                <div class="mt-2 flex flex-wrap items-center gap-3 text-sm">
                  <span class="px-2 py-1 rounded-lg border bg-white text-slate-700">Ø§Ù„Ù…Ø¯Ø©: <b>{{ off.proposed_duration_days }}</b> ÙŠÙˆÙ…</span>
                  <span class="px-2 py-1 rounded-lg border bg-white text-slate-700">Ø§Ù„Ù…Ø¨Ù„Øº: <b>{{ off.proposed_price }}</b> Ø±ÙŠØ§Ù„</span>
                </div>
              </div>

              <!-- Ø£Ø²Ø±Ø§Ø± Ù„Ù„Ø¹Ù…ÙŠÙ„ Ù„Ø§Ø®ØªÙŠØ§Ø±/Ø±ÙØ¶ Ø¹Ù†Ø¯Ù…Ø§ Ø§Ù„Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ -->
              <div class="shrink-0">
                {% if req.client_id == request.user.id and req.status == 'new' and off.status != 'selected' %}
                  <form method="post" action="{% url 'marketplace:offer_select_fn' off.pk %}">
                    {% csrf_token %}
                    <button class="btn btn-primary">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ø±Ø¶</button>
                  </form>
                {% elif off.status == 'selected' %}
                  <span class="px-2 py-1 rounded-lg text-xs bg-green-100 text-green-800 border border-green-200">Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®ØªØ§Ø±</span>
                {% endif %}
              </div>
            </div>
          </div>
          {% empty %}
          <div class="text-slate-500 text-sm">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ø±ÙˆØ¶ Ø¨Ø¹Ø¯.</div>
          {% endfor %}
        </div>
      </div>

      <!-- ===================== Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ© ===================== -->
      {% if req.agreement %}
        <div class="rounded-xl border bg-white p-4">
          <div class="flex items-center justify-between mb-3">
            <div class="text-slate-500 text-sm">Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ©</div>
            <div class="flex items-center gap-2">
              <span class="px-2 py-1 rounded-lg text-xs bg-slate-100 border text-slate-700">Ø±Ù‚Ù…: {{ req.agreement.pk }}</span>
              {% if req.agreement.status %}
                <span class="px-2 py-1 rounded-lg text-xs border
                            {% if req.agreement.status == 'accepted' %}bg-green-50 text-green-800 border-green-200
                            {% elif req.agreement.status == 'rejected' %}bg-rose-50 text-rose-700 border-rose-200
                            {% else %}bg-amber-50 text-amber-800 border-amber-200{% endif %}">
                  {{ req.agreement.get_status_display|default:req.agreement.status }}
                </span>
              {% endif %}
            </div>
          </div>

          <div class="flex flex-wrap items-center gap-3">
            <a class="btn btn-secondary" href="{% url 'agreements:open_by_request' req.pk %}">Ø¹Ø±Ø¶/ØªØ­Ø±ÙŠØ± Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ©</a>

            {% if request.user.id == req.client_id %}
              {% if req.status == "agreement_pending" or req.agreement.status == "pending" %}
                <form action="{% url 'agreements:accept_by_request' req.pk %}" method="post" class="inline">
                  {% csrf_token %}
                  <button class="btn btn-success">Ù…ÙˆØ§ÙÙ‚Ø©</button>
                </form>
                <a class="btn btn-danger" href="{% url 'agreements:reject_by_request' req.pk %}">Ø±ÙØ¶</a>
              {% endif %}
            {% endif %}

            {% if req.agreement.status == "accepted" %}
              <span class="text-xs text-slate-500">Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ© Ù…Ù‚Ø¨ÙˆÙ„Ø© â€” Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§.</span>
            {% endif %}
          </div>
        </div>
      {% else %}
        {% if req.status == "offer_selected" %}
          {% if request.user.id == req.assigned_employee_id or request.user.role == "admin" %}
          <div class="rounded-xl border bg-white p-4">
            <div class="flex items-center justify-between mb-3">
              <div class="text-slate-500 text-sm">Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ©</div>
            </div>
            <a class="px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 focus:ring-2 focus:ring-offset-1 focus:ring-indigo-500"
               href="{% url 'agreements:open_by_request' req.pk %}">
              Ø¥Ù†Ø´Ø§Ø¡/ÙØªØ­ Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ©
            </a>
            <p class="mt-2 text-xs text-slate-500">ÙŠÙ…ÙƒÙ† Ù„Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…Ø³Ù†Ø¯ Ø£Ùˆ Ø§Ù„Ù…Ø¯ÙŠØ± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ© Ø¨Ø¹Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø¹Ø±Ø¶.</p>
          </div>
          {% endif %}
        {% endif %}
      {% endif %}
      <!-- ===================================================== -->

      <!-- Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª (Ø¥Ù† ÙƒØ§Ù†Øª Ù…ÙØ¹Ù„Ø©) -->
      {% if uploads %}
      <div class="rounded-xl border bg-white p-4">
        <div class="flex items-center justify-between mb-3">
          <div class="text-slate-500 text-sm">Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª</div>
        </div>
        <ul class="grid sm:grid-cols-2 lg:grid-cols-3 gap-3">
          {% for up in uploads %}
          <li id="up-{{ up.id }}" class="rounded-lg border bg-slate-50 p-3">
            <div class="flex items-center justify_between gap-2">
              <a class="truncate text-indigo-700 hover:underline" href="{{ up.file.url }}" target="_blank" rel="noopener">ØªØ­Ù…ÙŠÙ„/Ø¹Ø±Ø¶</a>
              {% if up.can_delete %}
              <form method="post" action="{% url 'uploads:delete' up.id %}">
                {% csrf_token %}
                <button class="text-rose-600 text-sm hover:underline">Ø­Ø°Ù</button>
              </form>
              {% endif %}
            </div>
            <div class="text-xs text-slate-500 mt-1">{{ up.created_at|date:"Y-m-d H:i" }}</div>
          </li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}

      <!-- Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© (Ø¥Ù† ÙƒØ§Ù†Øª Ù…ÙØ¹Ù„Ø©) -->
      {% if thread_embed_url %}
      <div class="rounded-xl border bg-white p-4">
        <div class="flex items-center justify-between mb-3">
          <div class="text-slate-500 text-sm">Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</div>
        </div>
        <iframe src="{{ thread_embed_url }}" class="w-full h-[540px] rounded-xl border"></iframe>
      </div>
      {% endif %}

    </div>
  </div>

</section>
{% endblock %}
