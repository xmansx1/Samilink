{% extends "base.html" %}
{% load static %}
{% block title %}الإشعارات{% endblock %}

{% block content %}
<section class="rtl" dir="rtl">
  <div class="max-w-6xl mx-auto">

    <!-- العنوان وشريط الأدوات -->
    <div class="flex items-center justify-between gap-4 mb-6">
      <div>
        <h1 class="text-2xl md:text-3xl font-extrabold tracking-tight text-slate-900 dark:text-white">الإشعارات</h1>
        <p class="text-slate-500 dark:text-slate-400 text-sm mt-1">كل تنبيهاتك في مكان واحد — يمكنك البحث والفرز وتعليمها كمقروء.</p>
      </div>
      <div class="flex items-center gap-2">
        <form action="" method="get" class="hidden sm:flex items-center gap-2">
          <input type="text" name="q" value="{{ request.GET.q }}" placeholder="ابحث بالعنوان أو النص..."
                 class="input !py-2 !px-3 w-56" />
          <select name="status" class="input !py-2 !px-3 w-36">
            <option value="" {% if not request.GET.status %}selected{% endif %}>الكل</option>
            <option value="unread" {% if request.GET.status == 'unread' %}selected{% endif %}>غير مقروءة</option>
            <option value="read" {% if request.GET.status == 'read' %}selected{% endif %}>مقروءة</option>
          </select>
          <!-- بدلاً من split داخل القالب: خيارات ثابتة -->
          <select name="page_size" class="input !py-2 !px-3 w-28">
            {% with ps=request.GET.page_size|default:"20" %}
              <option value="10"  {% if ps == "10" %}selected{% endif %}>10</option>
              <option value="20"  {% if ps == "20" %}selected{% endif %}>20</option>
              <option value="30"  {% if ps == "30" %}selected{% endif %}>30</option>
              <option value="50"  {% if ps == "50" %}selected{% endif %}>50</option>
              <option value="100" {% if ps == "100" %}selected{% endif %}>100</option>
            {% endwith %}
          </select>
          <button class="nav-cta !py-2.5">تطبيق</button>
        </form>

        <!-- زر تعليم الكل -->
        <form action="{% url 'notifications:api_mark_all_read' %}" method="post"
              onsubmit="return confirm('تعليم جميع الإشعارات كمقروءة؟');">
          {% csrf_token %}
          <button class="px-4 py-2.5 rounded-xl border border-slate-200 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800 transition-all">
            تعليم الكل كمقروء
          </button>
        </form>
      </div>
    </div>

    <!-- فورم البحث (موبايل) -->
    <form action="" method="get" class="sm:hidden grid grid-cols-2 gap-2 mb-4">
      <input type="text" name="q" value="{{ request.GET.q }}" placeholder="ابحث..."
             class="input !py-2 !px-3 col-span-2" />
      <select name="status" class="input !py-2 !px-3">
        <option value="" {% if not request.GET.status %}selected{% endif %}>الكل</option>
        <option value="unread" {% if request.GET.status == 'unread' %}selected{% endif %}>غير مقروءة</option>
        <option value="read" {% if request.GET.status == 'read' %}selected{% endif %}>مقروءة</option>
      </select>
      <select name="page_size" class="input !py-2 !px-3">
        {% with ps=request.GET.page_size|default:"20" %}
          <option value="10"  {% if ps == "10" %}selected{% endif %}>10</option>
          <option value="20"  {% if ps == "20" %}selected{% endif %}>20</option>
          <option value="30"  {% if ps == "30" %}selected{% endif %}>30</option>
          <option value="50"  {% if ps == "50" %}selected{% endif %}>50</option>
          <option value="100" {% if ps == "100" %}selected{% endif %}>100</option>
        {% endwith %}
      </select>
      <button class="nav-cta !py-2.5 col-span-2">تطبيق</button>
    </form>

    <!-- قائمة الإشعارات -->
    <div class="rounded-2xl border border-slate-200 dark:border-slate-700 overflow-hidden bg-white dark:bg-slate-800">
      {% if notifications %}
        <ul class="divide-y divide-slate-200 dark:divide-slate-700">
          {% for n in notifications %}
          <li class="p-4 sm:p-5 hover:bg-slate-50/70 dark:hover:bg-slate-700/50 transition-colors">
            <div class="flex items-start gap-4">
              <div class="w-11 h-11 shrink-0 grid place-items-center rounded-xl
                          {% if n.is_read %}bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300
                          {% else %}bg-primary-600 text-white{% endif %}">
                <i class="fas fa-bell"></i>
              </div>

              <div class="flex-1 min-w-0">
                <div class="flex flex-wrap items-center gap-2">
                  <h3 class="font-semibold text-slate-900 dark:text-white truncate">{{ n.title|default:"إشعار" }}</h3>
                  {% if not n.is_read %}
                    <span class="badge badge-primary">غير مقروء</span>
                  {% else %}
                    <span class="badge badge-secondary">مقروء</span>
                  {% endif %}
                </div>

                {% if n.body %}
                <p class="text-sm text-slate-600 dark:text-slate-300 mt-1 whitespace-pre-line">
                  {{ n.body }}
                </p>
                {% endif %}

                <div class="text-xs text-slate-500 dark:text-slate-400 mt-2">
                  {{ n.created_at|date:"Y-m-d H:i" }}
                </div>

                <div class="mt-3 flex flex-wrap items-center gap-2">
                  {% if n.url %}
                    <a href="{{ n.url }}" class="text-xs px-3 py-1.5 rounded-lg border border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-700 transition">فتح</a>
                  {% endif %}

                  {% if not n.is_read %}
                  <form action="{% url 'notifications:api_mark_read' %}" method="post" class="inline">
                    {% csrf_token %}
                    <input type="hidden" name="id" value="{{ n.id }}">
                    <button class="text-xs px-3 py-1.5 rounded-lg border border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-700 transition">
                      تعليم كمقروء
                    </button>
                  </form>
                  {% endif %}
                </div>
              </div>
            </div>
          </li>
          {% endfor %}
        </ul>
      {% else %}
        <div class="p-8 text-center text-slate-500 dark:text-slate-400">لا توجد إشعارات حالياً.</div>
      {% endif %}
    </div>

    <!-- ترقيم الصفحات -->
    {% if is_paginated %}
    <div class="mt-6 flex items-center justify-between flex-wrap gap-3">
      <div class="text-sm text-slate-600 dark:text-slate-300">
        الصفحة {{ page_obj.number }} من {{ paginator.num_pages }}
        — إجمالي: {{ paginator.count }}
      </div>
      <div class="flex items-center gap-2">
        {% if page_obj.has_previous %}
          <a class="px-3 py-2 rounded-xl border hover:bg-slate-100 dark:hover:bg-slate-800 transition"
             href="?{% if request.GET.q %}q={{ request.GET.q|urlencode }}&amp;{% endif %}
                    {% if request.GET.status %}status={{ request.GET.status }}&amp;{% endif %}
                    {% if request.GET.page_size %}page_size={{ request.GET.page_size }}&amp;{% endif %}
                    page={{ page_obj.previous_page_number }}">
            السابق
          </a>
        {% else %}
          <span class="px-3 py-2 rounded-xl border opacity-40 cursor-not-allowed">السابق</span>
        {% endif %}

        {% if page_obj.has_next %}
          <a class="px-3 py-2 rounded-xl border hover:bg-slate-100 dark:hover:bg-slate-800 transition"
             href="?{% if request.GET.q %}q={{ request.GET.q|urlencode }}&amp;{% endif %}
                    {% if request.GET.status %}status={{ request.GET.status }}&amp;{% endif %}
                    {% if request.GET.page_size %}page_size={{ request.GET.page_size }}&amp;{% endif %}
                    page={{ page_obj.next_page_number }}">
            التالي
          </a>
        {% else %}
          <span class="px-3 py-2 rounded-xl border opacity-40 cursor-not-allowed">التالي</span>
        {% endif %}
      </div>
    </div>
    {% endif %}

  </div>
</section>
{% endblock %}
