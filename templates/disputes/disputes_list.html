{% extends "base.html" %}
{% block title %}نزاعات الطلب #{{ req.pk }}{% endblock %}
{% block content %}
<section class="max-w-3xl mx-auto rtl py-8" dir="rtl">

  <!-- العنوان وزر فتح نزاع -->
  <div class="flex items-center justify-between mb-4">
    <h1 class="text-xl font-bold">نزاعات الطلب #{{ req.pk }}</h1>
    <a class="btn btn-danger" href="{% url 'disputes:open' req.pk %}">فتح نزاع</a>
  </div>

  <div class="space-y-3">
    {% for d in disputes %}
      <div class="rounded-xl border p-4 bg-white dark:bg-slate-800">
        <div class="flex items-center justify-between gap-2">
          <div class="font-semibold truncate">{{ d.title }}</div>

          {# شارة الحالة مع لون بسيط #}
          {% if d.status == 'open' %}
            <span class="px-2 py-1 rounded-lg text-xs border bg-amber-50 text-amber-700 dark:bg-slate-900">مفتوح</span>
          {% elif d.status == 'in_review' %}
            <span class="px-2 py-1 rounded-lg text-xs border bg-sky-50 text-sky-700 dark:bg-slate-900">قيد المراجعة</span>
          {% elif d.status == 'resolved' %}
            <span class="px-2 py-1 rounded-lg text-xs border bg-emerald-50 text-emerald-700 dark:bg-slate-900">محسوم</span>
          {% elif d.status == 'canceled' %}
            <span class="px-2 py-1 rounded-lg text-xs border bg-slate-100 text-slate-600 dark:bg-slate-900">ملغي</span>
          {% else %}
            <span class="px-2 py-1 rounded-lg text-xs border bg-white dark:bg-slate-900">
              {{ d.get_status_display|default:d.status }}
            </span>
          {% endif %}
        </div>

        <div class="text-xs text-slate-500 mt-1">
          فتح بواسطة: {{ d.opened_by|default:"—" }}
          — الدور: {{ d.opener_role|default:"—" }}
          — {{ d.opened_at|default:d.created_at|date:"Y-m-d H:i" }}
        </div>

        {# السبب/التفاصيل #}
        {% if d.reason %}
          <div class="mt-3 text-sm">
            <b class="text-slate-600">السبب:</b>
            <span class="whitespace-pre-line">{{ d.reason }}</span>
          </div>
        {% endif %}
        {% if d.details %}
          <div class="mt-2 text-sm">
            <b class="text-slate-600">التفاصيل:</b>
            <div class="whitespace-pre-line">{{ d.details }}</div>
          </div>
        {% endif %}

        {# أزرار الإدارة (تظهر فقط للإداري/المالية؛ الحماية الحقيقية في الـview) #}
        {% if request.user.is_staff or request.user.is_superuser or request.user.role in ('admin','finance') %}
          <div class="mt-4 flex flex-wrap gap-2">
            <form method="post" action="{% url 'disputes:update_status' d.pk %}">
              {% csrf_token %}
              <button name="action" value="review" class="btn btn-secondary btn-sm">بدء مراجعة</button>
            </form>
            <form method="post" action="{% url 'disputes:update_status' d.pk %}">
              {% csrf_token %}
              <button name="action" value="resolve" class="btn btn-success btn-sm">حلّ النزاع</button>
            </form>
            <form method="post" action="{% url 'disputes:update_status' d.pk %}">
              {% csrf_token %}
              <button name="action" value="cancel" class="btn btn-outline btn-sm">إلغاء</button>
            </form>
            <form method="post" action="{% url 'disputes:update_status' d.pk %}">
              {% csrf_token %}
              <button name="action" value="reopen" class="btn btn-danger btn-sm">إعادة فتح</button>
            </form>
          </div>
        {% endif %}

      </div>
    {% empty %}
      <div class="text-slate-500 text-sm">لا توجد نزاعات لهذا الطلب.</div>
    {% endfor %}
  </div>
</section>
{% endblock %}
